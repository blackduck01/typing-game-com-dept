<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ„ ê°•ì˜ í‰ê°€ íˆ¬í‘œì†Œ ğŸ…</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;500;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">

    <style>
        /* ğŸ¨ ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        body { background: linear-gradient(135deg, #0f2027, #203a43, #2c5364); margin: 0; padding: 20px 10px; color: #fff; font-family: 'Noto Sans KR', sans-serif; min-height: 100vh; overflow-x: hidden; -webkit-tap-highlight-color: transparent; padding-bottom: 120px; }
        .snowflake { position: fixed; top: -10px; color: rgba(255, 255, 255, 0.5); font-size: 1em; z-index: 0; pointer-events: none; animation: fall linear infinite; }
        @keyframes fall { to { transform: translateY(110vh); } }
        .container { max-width: 600px; margin: 0 auto; text-align: center; position: relative; z-index: 10; }
        h1 { font-family: 'Jua', sans-serif; font-size: 1.8rem; margin: 20px 0 5px 0; font-weight: 400; text-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        h1 .red { color: #ff5252; } h1 .green { color: #69f0ae; } h1 .gold { color: #FFD700; }
        .subtitle { color: #ccc; font-size: 0.9rem; margin-bottom: 20px; font-weight: 300; }
        .category-scroll-wrapper { overflow-x: auto; white-space: nowrap; padding-bottom: 10px; margin-bottom: 10px; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
        .category-scroll-wrapper::-webkit-scrollbar { display: none; }
        .category-nav { display: inline-flex; gap: 8px; padding: 0 5px; }
        .cat-btn { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: #ccc; padding: 8px 14px; border-radius: 20px; font-size: 0.9rem; cursor: pointer; transition: all 0.2s; flex-shrink: 0; font-family: 'Jua', sans-serif; }
        .cat-btn.active { background: #d32f2f; color: #fff; border-color: #ff5252; box-shadow: 0 0 10px rgba(255, 82, 82, 0.5); transform: scale(1.05); }
        .review-list { display: flex; flex-direction: column; gap: 15px; min-height: 300px; }
        .review-card { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border-radius: 16px; padding: 20px; text-align: left; border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: transform 0.2s; animation: fadeIn 0.3s ease-out; position: relative; overflow: hidden; }
        .review-card::top { content: ''; position: absolute; top:0; left:0; width:100%; height: 4px; background: #FFD700; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .review-card.voted { border: 2px solid #69f0ae; background: rgba(46, 204, 113, 0.15); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .subject-tag { font-size: 0.8rem; color: #fff; background: #d32f2f; padding: 4px 8px; border-radius: 8px; margin-right: 8px; font-weight: bold; }
        .subject-name { font-size: 1.2rem; font-weight: 700; color: #fff; }
        .star-rating { display: flex; flex-direction: row-reverse; justify-content: center; gap: 8px; margin: 10px 0; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 50px; }
        .star-rating input { display: none; }
        .star-rating label { font-size: 2rem; color: #555; cursor: pointer; transition: color 0.2s; }
        .star-rating input:checked ~ label, .star-rating label:hover, .star-rating label:hover ~ label { color: #FFD700; text-shadow: 0 0 15px #FFD700; }
        .comment-input { width: 100%; padding: 12px; font-size: 1rem; border-radius: 12px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: white; margin-bottom: 12px; box-sizing: border-box; outline: none; transition: all 0.3s; }
        .comment-input:focus { border-color: #FFD700; background: rgba(0,0,0,0.5); }
        .submit-btn { width: 100%; padding: 14px; font-size: 1rem; border: none; border-radius: 12px; background: linear-gradient(135deg, #2e7d32, #1b5e20); color: #fff; font-weight: bold; font-family: 'Jua', sans-serif; cursor: pointer; box-shadow: 0 4px 10px rgba(27, 94, 32, 0.4); transition: active 0.1s; }
        .submit-btn:active { transform: scale(0.98); }
        .voted .submit-btn { background: #444; color: #FFD700; box-shadow: none; border: 1px solid #FFD700; }
        .footer-msg { margin-top: 40px; font-size: 0.8rem; color: #888; line-height: 1.6; padding: 20px; border-top: 1px dashed rgba(255,255,255,0.1); }
        .no-result { color: #888; margin-top: 50px; font-size: 0.9rem; }

        /* ğŸ”¥ ì¼ê´„ ì œì¶œ ë²„íŠ¼ (ê³ ì •) */
        .fab-container { position: fixed; bottom: 40px; left: 0; width: 100%; display: flex; justify-content: center; z-index: 9999; pointer-events: none; }
        .batch-submit-btn { pointer-events: auto; background: linear-gradient(45deg, #FFD700, #FFC107); color: #333; font-family: 'Jua', sans-serif; font-size: 1.1rem; font-weight: bold; padding: 15px 40px; border-radius: 50px; box-shadow: 0 6px 20px rgba(0,0,0,0.5); border: 2px solid #fff; cursor: pointer; transition: transform 0.2s; display: flex; align-items: center; gap: 8px; }
        .batch-submit-btn:active { transform: scale(0.95); }

        /* ğŸ”¥ [ìˆ˜ì •ë¨] ê³¼ëª© ì¶”ê°€ ë²„íŠ¼: ì—„ì²­ ëˆˆì— ë„ê²Œ ë³€ê²½! */
        .add-subject-btn {
            display: block; 
            width: 100%; 
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 215, 0, 0.15); /* ë…¸ë€ë¹› ë°°ê²½ */
            border: 2px dashed #FFD700; /* ì§„í•œ ë…¸ë€ ì ì„  í…Œë‘ë¦¬ */
            color: #FFD700; /* ë…¸ë€ ê¸€ì”¨ */
            font-weight: bold;
            font-family: 'Jua', sans-serif;
            font-size: 1.1rem;
            border-radius: 15px;
            cursor: pointer; 
            transition: all 0.2s;
            animation: pulse 2s infinite; /* ë°˜ì§ë°˜ì§ íš¨ê³¼ */
        }
        .add-subject-btn:hover { background: rgba(255, 215, 0, 0.3); transform: scale(1.02); }
        
        /* ë°˜ì§ì´ëŠ” ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(255, 215, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); }
        }
    </style>
</head>
<body>

    <div id="snow-container"></div>

    <div class="container">
        <h1>
            <span class="red">H</span><span class="green">a</span><span class="red">p</span><span class="green">p</span><span class="red">y</span>
            <span class="gold">Vote</span> ğŸ—³ï¸
        </h1>
        <p class="subtitle">ğŸ„ ìˆ˜ì •ë„ ê°€ëŠ¥! êµì–‘ ê³¼ëª© ì¶”ê°€ë„ ê°€ëŠ¥! ğŸ…</p>

        <div class="category-scroll-wrapper">
            <div class="category-nav" id="category-nav">
                <button class="cat-btn active" onclick="filterCategory('all')">ì „ì²´</button>
            </div>
        </div>

        <button class="add-subject-btn" onclick="addCustomSubject()">
            â• ì°¾ëŠ” ê³¼ëª©ì´ ì—†ë‚˜ìš”? ì§ì ‘ ì¶”ê°€í•˜ê¸°
        </button>

        <div class="review-list" id="review-list"></div>

        <div class="footer-msg">
            íˆ¬í‘œí•´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤ â˜ƒï¸<br>
            ê²°ê³¼ëŠ” íŒŒí‹° í˜„ì¥ì—ì„œ ê³µê°œë©ë‹ˆë‹¤!
        </div>
    </div>

    <div class="fab-container">
        <button class="batch-submit-btn" onclick="submitAllVotes()">
            ğŸ“® ì„ íƒí•œ ê²ƒ ì¼ê´„ ì œì¶œí•˜ê¸°
        </button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, runTransaction, set } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA_Rs8og9eT47qbYZYqBcLv6VGh0nZxumw",
            authDomain: "review-class-28dda.firebaseapp.com",
            databaseURL: "https://review-class-28dda-default-rtdb.firebaseio.com",
            projectId: "review-class-28dda",
            storageBucket: "review-class-28dda.firebasestorage.app",
            messagingSenderId: "256031114562",
            appId: "1:256031114562:web:f6d8a80f0aabd77cea34db",
            measurementId: "G-L56ETZH2RE"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let userId = localStorage.getItem('my_user_id');
        if (!userId) {
            userId = 'user_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('my_user_id', userId);
        }

        // ê¸°ë³¸ ê³¼ëª© ë¦¬ìŠ¤íŠ¸
        let subjects = [
             { id: 's1', name: 'ì»´í“¨í„°ì˜ì´í•´' }, { id: 's2', name: 'ìœ ë¹„ì¿¼í„°ìŠ¤ì»´í“¨íŒ…ê°œë¡ ' }, { id: 's3', name: 'íŒŒì´ì¬í”„ë¡œê·¸ë˜ë°ê¸°ì´ˆ' }, { id: 's4', name: 'ë°ì´í„°ì •ë³´ì²˜ë¦¬ì…ë¬¸' },
             { id: 's5', name: 'ì´ì‚°ìˆ˜í•™' }, { id: 's6', name: 'Javaí”„ë¡œê·¸ë˜ë°' }, { id: 's7', name: 'HTML5ì›¹í”„ë¡œê·¸ë˜ë°' },
             { id: 's8', name: 'ê·¸ë˜í”½ì»¤ë®¤ë‹ˆì¼€ì´ì…˜' }, { id: 's9', name: 'ë°ì´í„°ë² ì´ìŠ¤ì‹œìŠ¤í…œ' }, { id: 's10', name: 'ë””ì§€í„¸ë…¼ë¦¬íšŒë¡œ' }, { id: 's11', name: 'ìš´ì˜ì²´ì œ' }, { id: 's12', name: 'ì¸ê³µì§€ëŠ¥' }, { id: 's13', name: 'ì•Œê³ ë¦¬ì¦˜' },
             { id: 's14', name: 'ì»´í“¨í„°ê·¸ë˜í”½ìŠ¤' }, { id: 's15', name: 'ëª¨ë°”ì¼ì•±í”„ë¡œê·¸ë˜ë°' }, { id: 's16', name: 'ì»´í“¨í„°ë³´ì•ˆ' }, { id: 's17', name: 'ì†Œí”„íŠ¸ì›¨ì–´ê³µí•™' }, { id: 's18', name: 'ì •ë³´í†µì‹ ë§' },
             { id: 's19', name: 'ì»´í“¨í„°ê³¼í•™ê°œë¡ ' }, { id: 's20', name: 'ë©€í‹°ë¯¸ë””ì–´ì‹œìŠ¤í…œ' }, { id: 's21', name: 'Cí”„ë¡œê·¸ë˜ë°' },
             { id: 's22', name: 'ëŒ€í•™ìˆ˜í•™ì˜ì´í•´' }, { id: 's23', name: 'ì˜¤í”ˆì†ŒìŠ¤ê¸°ë°˜ë°ì´í„°ë¶„ì„' }, { id: 's24', name: 'ìë£Œêµ¬ì¡°' }, { id: 's25', name: 'ì„ í˜•ëŒ€ìˆ˜' }, { id: 's26', name: 'í”„ë¡œê·¸ë˜ë°ì–¸ì–´ë¡ ' },
             { id: 's27', name: 'ì»´í“¨í„°êµ¬ì¡°' }, { id: 's28', name: 'JSPí”„ë¡œê·¸ë˜ë°' }, { id: 's29', name: 'UNIXì‹œìŠ¤í…œ' }, { id: 's30', name: 'ì‹œë®¬ë ˆì´ì…˜' }, { id: 's31', name: 'ë¨¸ì‹ ëŸ¬ë‹' },
             { id: 's32', name: 'í´ë¼ìš°ë“œì»´í“¨íŒ…' }, { id: 's33', name: 'ì»´íŒŒì¼ëŸ¬êµ¬ì„±' }, { id: 's34', name: 'ë”¥ëŸ¬ë‹' }, { id: 's35', name: 'ë¹…ë°ì´í„°ì˜ì´í•´ì™€í™œìš©' }
        ];

        function getChosung(str) {
            const chosung = ["ã„±","ã„²","ã„´","ã„·","ã„¸","ã„¹","ã…","ã…‚","ã…ƒ","ã……","ã…†","ã…‡","ã…ˆ","ã…‰","ã…Š","ã…‹","ã…Œ","ã…","ã…"];
            const code = str.charCodeAt(0) - 44032;
            if (code < 0 || code > 11171) {
                if (/[a-zA-Z]/.test(str[0])) return 'A-Z';
                return 'ê¸°íƒ€';
            }
            return chosung[Math.floor(code / 588)];
        }
        
        subjects = subjects.map(sub => ({ ...sub, chosung: getChosung(sub.name) }));

        // ì €ì¥ëœ ì»¤ìŠ¤í…€ ê³¼ëª© ë¶ˆëŸ¬ì˜¤ê¸°
        const customSubs = JSON.parse(localStorage.getItem('my_custom_subjects')) || [];
        customSubs.forEach(sub => {
            sub.chosung = getChosung(sub.name);
            subjects.unshift(sub);
        });

        // ì¹´í…Œê³ ë¦¬
        const navContainer = document.getElementById('category-nav');
        const activeCategories = [...new Set(subjects.map(s => s.chosung))].sort();
        if(activeCategories.includes('A-Z')) activeCategories.push(activeCategories.splice(activeCategories.indexOf('A-Z'), 1)[0]);
        activeCategories.forEach(cat => {
            const btn = document.createElement('button');
            btn.className = 'cat-btn';
            btn.innerText = cat;
            btn.onclick = () => filterCategory(cat);
            navContainer.appendChild(btn);
        });

        const listContainer = document.getElementById('review-list');
        let currentCategory = 'all';

        window.filterCategory = function(cat) {
            currentCategory = cat;
            document.querySelectorAll('.cat-btn').forEach(btn => {
                if((cat === 'all' && btn.innerText === 'ì „ì²´') || btn.innerText === cat) btn.classList.add('active');
                else btn.classList.remove('active');
            });
            renderCards();
        }

        // ğŸ”¥ ê³¼ëª© ì¶”ê°€ í•¨ìˆ˜ (ì „ì—­)
        window.addCustomSubject = function() {
            const name = prompt("ì¶”ê°€í•  ê³¼ëª©ëª…(êµì–‘/ê¸°íƒ€)ì„ ì…ë ¥í•´ì£¼ì„¸ìš”! âœ¨");
            if (!name) return;

            if (subjects.find(s => s.name === name)) {
                alert("ì´ë¯¸ ë¦¬ìŠ¤íŠ¸ì— ìˆëŠ” ê³¼ëª©ì…ë‹ˆë‹¤!");
                return;
            }

            const newId = 'custom_' + Date.now();
            const newSubject = { id: newId, name: name };
            
            newSubject.chosung = getChosung(name);
            subjects.unshift(newSubject);
            
            const savedCustoms = JSON.parse(localStorage.getItem('my_custom_subjects')) || [];
            savedCustoms.push(newSubject);
            localStorage.setItem('my_custom_subjects', JSON.stringify(savedCustoms));

            alert(`'${name}' ê³¼ëª©ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤! ë§¨ ìœ„ì—ì„œ íˆ¬í‘œí•´ì£¼ì„¸ìš”. ğŸ—³ï¸`);
            filterCategory('all');
        }

        function renderCards() {
            listContainer.innerHTML = '';
            const filtered = subjects.filter(sub => currentCategory === 'all' || sub.chosung === currentCategory).sort((a, b) => {
                return a.name.localeCompare(b.name);
            });

            if(filtered.length === 0) {
                listContainer.innerHTML = '<div class="no-result">í•´ë‹¹í•˜ëŠ” ê³¼ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            filtered.forEach(sub => {
                const savedData = JSON.parse(localStorage.getItem(`my_vote_${sub.id}`));
                const isVoted = !!savedData;
                
                const btnText = isVoted ? 'ìˆ˜ì •í•˜ê¸° âœï¸' : 'ì œì¶œí•˜ê¸° ğŸ„';
                const btnClass = isVoted ? 'voted' : '';
                const savedComment = savedData ? savedData.text : "";
                const savedScore = savedData ? savedData.score : 0;
                
                const card = document.createElement('div');
                card.className = `review-card ${btnClass}`;
                card.id = `card-${sub.id}`; 
                
                let starHtml = '';
                for(let i=5; i>=1; i--) {
                    const checked = (savedScore == i) ? 'checked' : '';
                    starHtml += `<input type="radio" name="rate_${sub.id}" id="rate_${sub.id}_${i}" value="${i}" ${checked}><label for="rate_${sub.id}_${i}">â˜…</label>`;
                }

                card.innerHTML = `
                    <div class="card-header">
                        <div><span class="subject-tag">${sub.chosung}</span><span class="subject-name">${sub.name}</span></div>
                    </div>
                    <div class="star-rating">${starHtml}</div>
                    
                    <input type="text" class="comment-input" id="comment-${sub.id}" placeholder="í•œ ì¤„ í‰ (ì„ íƒ)" value="${savedComment}">
                    
                    <button class="submit-btn" id="btn-${sub.id}" onclick="submitSingle('${sub.id}', '${sub.name}')">${btnText}</button>
                `;
                listContainer.appendChild(card);
            });
        }

        window.submitSingle = function(id, name) {
            processVote(id, name, false);
        }

        window.submitAllVotes = async function() {
            let submitCount = 0;
            const promises = [];

            for (const sub of subjects) {
                const radios = document.getElementsByName(`rate_${sub.id}`);
                let score = 0;
                for (const r of radios) if (r.checked) score = parseInt(r.value);

                if (score > 0) {
                    promises.push(processVote(sub.id, sub.name, true)); 
                    submitCount++;
                }
            }

            if (submitCount === 0) {
                alert("ì„ íƒëœ ê³¼ëª©ì´ ì—†ìŠµë‹ˆë‹¤! ë³„ì ì„ ë¨¼ì € ëˆŒëŸ¬ì£¼ì„¸ìš” â­");
                return;
            }

            await Promise.all(promises);
            launchConfetti();
            alert(`ì´ ${submitCount}ê°œ ê³¼ëª©ì´ ì¼ê´„ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤! ğŸš€`);
        }

        function processVote(id, name, isBatch) {
            return new Promise((resolve, reject) => {
                const radios = document.getElementsByName(`rate_${id}`);
                let score = 0;
                for (const r of radios) if (r.checked) score = parseInt(r.value);

                if (score === 0) {
                    if (!isBatch) alert("ë³„ì„ ëˆŒëŸ¬ ì ìˆ˜ë¥¼ ì£¼ì„¸ìš”! â­");
                    resolve();
                    return;
                }

                const commentInput = document.getElementById(`comment-${id}`);
                const commentText = commentInput ? commentInput.value.trim() : "";
                
                const oldData = JSON.parse(localStorage.getItem(`my_vote_${id}`));
                const oldScore = oldData ? oldData.score : 0;

                const scoreRef = ref(db, 'votes/' + id);
                
                runTransaction(scoreRef, (currentData) => {
                    if (currentData === null) {
                        return { total: score, count: 1, name: name };
                    } else {
                        if (oldData) {
                            return { total: currentData.total - oldScore + score, count: currentData.count, name: name }; 
                        } else {
                            return { total: currentData.total + score, count: currentData.count + 1, name: name };
                        }
                    }
                }).then(() => {
                    if(commentText) {
                        set(ref(db, `comments/${id}/${userId}`), {
                            text: commentText,
                            score: score,
                            timestamp: Date.now()
                        });
                    }
                    localStorage.setItem(`my_vote_${id}`, JSON.stringify({ score: score, text: commentText }));
                    
                    const btn = document.getElementById(`btn-${id}`);
                    const card = document.getElementById(`card-${id}`);
                    if(btn && card) {
                        btn.innerText = "ìˆ˜ì •í•˜ê¸° âœï¸";
                        card.classList.add("voted");
                        btn.style.background = "#444";
                        btn.style.color = "#FFD700";
                        btn.style.border = "1px solid #FFD700";
                        btn.style.boxShadow = "none";
                    }

                    if (!isBatch) {
                        alert(oldData ? "ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤! âœï¸" : "ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ„");
                        if(score === 5) launchConfetti();
                    }
                    resolve();

                }).catch(err => { 
                    console.error(err); 
                    if(!isBatch) alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤!");
                    resolve();
                });
            });
        }

        function launchConfetti() {
            const colors = ['#d32f2f', '#388e3c', '#FFD700', '#ffffff'];
            for(let i=0; i<50; i++) {
                const p = document.createElement('div');
                p.className = 'confetti';
                p.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                p.style.left = '50%'; 
                p.style.top = (window.scrollY + window.innerHeight / 2) + 'px';
                document.body.appendChild(p);
                const angle = Math.random() * Math.PI * 2;
                const velocity = Math.random() * 150 + 50;
                p.animate([{ transform: 'translate(0,0) scale(1)', opacity: 1 }, { transform: `translate(${Math.cos(angle)*velocity}px, ${Math.sin(angle)*velocity}px) scale(0)`, opacity: 0 }], { duration: 1000, easing: 'ease-out' }).onfinish = () => p.remove();
            }
        }

        function createSnow() {
            const container = document.getElementById('snow-container');
            for(let i=0; i<40; i++){
                const snow = document.createElement('div');
                snow.className = 'snowflake';
                snow.innerHTML = 'â„';
                snow.style.left = Math.random() * 100 + 'vw';
                snow.style.animationDuration = Math.random() * 5 + 5 + 's'; 
                container.appendChild(snow);
            }
        }
        createSnow();
        renderCards();
    </script>
</body>
</html>
